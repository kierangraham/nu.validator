--- mathml2-common.rnc	2010-12-22 13:01:48.000000000 +0900
+++ mathml2-common.rnc	2010-12-22 13:17:44.000000000 +0900
@@ -2,22 +2,29 @@
 # application for describing mathematical notation and capturing
 # both its structure and content.
 # 
+# With additional changes for integration into the validator.nu system.
+#
 # Copyright 1998-2010 W3C (MIT, ERCIM, Keio)
+# Copyright 2010 Mozilla Foundation
 # 
 # Use and distribution of this code are permitted under the terms
 # W3C Software Notice and License
 # http://www.w3.org/Consortium/Legal/2002/copyright-software-20021231
 
 namespace local = ""
+# added OpenMath namespace -- mike
+namespace om = "http://www.openmath.org/OpenMath"
 default namespace ns1 = "http://www.w3.org/1998/Math/MathML"
+# added namespace for HTML5 datatype library -- mike
+datatypes w = "http://whattf.org/datatype-draft"
 
-start = math
 math = element math { math.attributes, MathExpression* }
 MathExpression = semantics
 NonMathMLAtt = attribute * - (local:* | ns1:*) { xsd:string }
 CommonDeprecatedAtt = attribute other { text }?
+# changed datatype of id attr from ID to w:xml-name -- mike
 CommonAtt =
-  attribute id { xsd:ID }?,
+  attribute id { w:xml-name }?,
   attribute xref { text }?,
   attribute class { xsd:NMTOKENS }?,
   attribute style { xsd:string }?,
@@ -46,16 +53,66 @@
 name = attribute name { xsd:NCName }
 src = attribute src { xsd:anyURI }?
 annotation = element annotation { annotation.attributes, text }
-annotation-xml.model = (MathExpression | anyElement)*
-anyElement =
-  element * - ns1:* {
-    (attribute * { text }
-     | text
-     | anyElement)*
-  }
+# changed content model of annotation-xml -- mike
 annotation-xml =
-  element annotation-xml { annotation.attributes, annotation-xml.model }
+    ( annotation-xml.xhtml
+    | annotation-xml.svg
+    | annotation-xml.mathml
+    | annotation-xml.openmath
+    )
+    annotation-xml.model = (MathExpression | anyElement)*
+    anyElement =
+      element * - ns1:* {
+        (attribute * { text }
+         | text
+         | anyElement)*
+      }
+    annotation-xml.xhtml =
+        element annotation-xml {
+            annotation-xml.model, annotation-xml.attributes, att-encoding.xhtml?
+        }
+        annotation-xml.model.xhtml = 
+          notAllowed
+        att-encoding.xhtml =
+          attribute encoding {
+            string "application/xhtml+xml" | string "text/html"
+          }
+    annotation-xml.svg =
+        element annotation-xml {
+            annotation-xml.model, annotation-xml.attributes, att-encoding.svg?
+        }
+        annotation-xml.model.svg = 
+          notAllowed
+        att-encoding.svg =
+          attribute encoding {
+            string "SVG1.1"
+          }
+    annotation-xml.mathml =
+        element annotation-xml {
+            annotation-xml.model, annotation-xml.attributes, att-encoding.mathml?
+        }
+        annotation-xml.model.mathml = 
+          math
+        att-encoding.mathml =
+          attribute encoding {
+            string "MathML" | string "MathML-Content"
+          }
+    annotation-xml.openmath =
+        element annotation-xml {
+            annotation-xml.model, annotation-xml.attributes, att-encoding.openmath?
+        }
+        annotation-xml.model.openmath = 
+          openmath.any.elem
+        att-encoding.openmath =
+          attribute encoding {
+            string "OpenMath"
+          }
+        openmath.any.elem =
+          element om:* {
+            attribute * { text }*, annotation-xml.model
+          }
 annotation.attributes = CommonAtt, name?, DefEncAtt, src?
+annotation-xml.attributes = CommonAtt, name?, src?
 DefEncAtt =
   attribute encoding { xsd:string }?,
   attribute definitionURL { xsd:anyURI }?
--- mathml2-content.rnc	2010-12-22 13:01:49.000000000 +0900
+++ mathml2-content.rnc	2010-12-22 13:22:48.000000000 +0900
@@ -2,18 +2,21 @@
 # application for describing mathematical notation and capturing
 # both its structure and content.
 # 
+# With additional changes for integration into the validator.nu system.
+#
 # Copyright 1998-2010 W3C (MIT, ERCIM, Keio)
+# Copyright 2010 Mozilla Foundation
 # 
 # Use and distribution of this code are permitted under the terms
 # W3C Software Notice and License
 # http://www.w3.org/Consortium/Legal/2002/copyright-software-20021231
-include "mathml3-restricted-strict-content.rnc" {
+include "mathml2-strict-content.rnc" {
   cn.content = (text | mglyph | sep | PresentationExpression)*
   cn.attributes =
     CommonAtt,
     DefEncAtt,
     attribute type { text }?,
-    base?
+    math-base?
   ci.attributes = CommonAtt, DefEncAtt, ci.type?
   ci.type = attribute type { text }
   ci.content = (text | mglyph | PresentationExpression)*
@@ -28,7 +31,8 @@
   apply.content = ContExp+ | (ContExp, BvarQ, Qualifier*, ContExp*)
   bind.content = apply.content
 }
-base = attribute base { text }
+# changed pattern name to math-base to avoid name conflict - mike
+math-base = attribute base { text }
 sep = element sep { empty }
 PresentationExpression |= notAllowed
 DomainQ =
@@ -67,13 +71,14 @@
 interval =
   element interval { CommonAtt, DefEncAtt, closure?, ContExp, ContExp }
 unary-functional.class =
-  inverse | ident | domain | codomain | image | ln | log | moment
+  inverse | ident | domain | codomain | math-image | ln | log | moment
 ContExp |= unary-functional.class
 inverse = element inverse { CommonAtt, DefEncAtt, empty }
 ident = element ident { CommonAtt, DefEncAtt, empty }
 domain = element domain { CommonAtt, DefEncAtt, empty }
 codomain = element codomain { CommonAtt, DefEncAtt, empty }
-image = element image { CommonAtt, DefEncAtt, empty }
+# changed pattern name to math-image to avoid name conflict - mike
+math-image = element image { CommonAtt, DefEncAtt, empty }
 ln = element ln { CommonAtt, DefEncAtt, empty }
 log = element log { CommonAtt, DefEncAtt, empty }
 moment = element moment { CommonAtt, DefEncAtt, empty }
@@ -168,9 +173,10 @@
 grad = element grad { CommonAtt, DefEncAtt, empty }
 curl = element curl { CommonAtt, DefEncAtt, empty }
 laplacian = element laplacian { CommonAtt, DefEncAtt, empty }
-nary-setlist-constructor.class = set | \list
+nary-setlist-constructor.class = math-set | \list
 ContExp |= nary-setlist-constructor.class
-set =
+# changed pattern name to math-set to avoid name conflict - mike
+math-set =
   element set {
     CommonAtt, DefEncAtt, type?, BvarQ*, DomainQ*, ContExp*
   }
--- mathml2-presentation.rnc	2010-12-22 13:01:51.000000000 +0900
+++ mathml2-presentation.rnc	2010-12-22 13:27:21.000000000 +0900
@@ -2,7 +2,10 @@
 # application for describing mathematical notation and capturing
 # both its structure and content.
 # 
+# With additional changes for integration into the validator.nu system.
+#
 # Copyright 1998-2010 W3C (MIT, ERCIM, Keio)
+# Copyright 2010 Mozilla Foundation
 # 
 # Use and distribution of this code are permitted under the terms
 # W3C Software Notice and License
@@ -82,8 +85,12 @@
   attribute largeop { "true" | "false" }?,
   attribute movablelimits { "true" | "false" }?,
   attribute accent { "true" | "false" }?
-mtext = element mtext { mtext.attributes, token.content* }
+# changed mtext content model to use mtext.content instead of generic
+# token.content, because we want to handle mtext differently than other
+# MathML "token elements" -- mike
+mtext = element mtext { mtext.attributes, mtext.content* }
 mtext.attributes = CommonAtt, CommonPresAtt, TokenAtt
+mtext.content = mglyph | malignmark | text
 mspace = element mspace { mspace.attributes, empty }
 mspace.attributes =
   CommonAtt,
--- mathml2.rnc	2010-12-22 13:01:52.000000000 +0900
+++ mathml2.rnc	2010-12-22 13:50:09.000000000 +0900
@@ -2,21 +2,16 @@
 # application for describing mathematical notation and capturing
 # both its structure and content.
 # 
+# With additional changes for integration into the validator.nu system.
+#
 # Copyright 1998-2010 W3C (MIT, ERCIM, Keio)
+# Copyright 2010 Mozilla Foundation
 # 
 # Use and distribution of this code are permitted under the terms
 # W3C Software Notice and License
 # http://www.w3.org/Consortium/Legal/2002/copyright-software-20021231
 
-namespace a = "http://relaxng.org/ns/compatibility/annotations/1.0"
-namespace m = "http://www.w3.org/1998/Math/MathML"
-
-
-## Content  MathML
-include "mathml3-restricted-content.rnc" inherit = m
-
-## Presentation MathML
-include "mathml3-restricted-presentation.rnc" inherit = m
-
-## math and semantics common to both Content and Presentation
-include "mathml3-restricted-common.rnc" inherit = m
+# moved necessary includes in mathml2-inc.rnc file and we then just include
+# that here; also, set start = math -- mike
+include "mathml2-inc.rnc"
+start = math
